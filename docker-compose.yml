version: '3.8'

services:
  python-secure:
    build:
      context: .
      dockerfile_inline: |
        FROM scratch
        # This service uses the Nix-built image directly
    image: ghcr.io/reaslab/docker-python-runner:secure-latest
    container_name: python-secure
    volumes:
      - ./test:/app
      - ./gurobi.lic:/app/gurobi.lic:ro
    environment:
      - GRB_LICENSE_FILE=/app/gurobi.lic
      - PYTHONPATH=/app:/tmp/.local/lib/python3.12/site-packages
    working_dir: /app
    command: tail -f /dev/null
    # Security settings
    read_only: true
    user: "1000:1000"
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    tmpfs:
      - /tmp:nosuid,size=2g,uid=1000,gid=1000,mode=755
      - /.cache:nosuid,size=1g,uid=1000,gid=1000,mode=755
      - /.local:nosuid,size=1g,uid=1000,gid=1000,mode=755
      - /.local/share:nosuid,size=512m,uid=1000,gid=1000,mode=755
      - /.uv_cache:nosuid,size=1g,uid=1000,gid=1000,mode=755
    networks:
      - python-network

  python-dev:
    image: ghcr.io/reaslab/docker-python-runner:secure-latest
    container_name: python-dev
    volumes:
      - ./test:/app
      - ./gurobi.lic:/app/gurobi.lic:ro
    environment:
      - GRB_LICENSE_FILE=/app/gurobi.lic
      - PYTHONPATH=/app:/tmp/.local/lib/python3.12/site-packages
    working_dir: /app
    command: bash
    # Development mode - less restrictive
    user: "1000:1000"
    tmpfs:
      - /tmp:nosuid,size=2g,uid=1000,gid=1000,mode=755
      - /.cache:nosuid,size=1g,uid=1000,gid=1000,mode=755
      - /.local:nosuid,size=1g,uid=1000,gid=1000,mode=755
      - /.local/share:nosuid,size=512m,uid=1000,gid=1000,mode=755
      - /.uv_cache:nosuid,size=1g,uid=1000,gid=1000,mode=755
    networks:
      - python-network

networks:
  python-network:
    driver: bridge
